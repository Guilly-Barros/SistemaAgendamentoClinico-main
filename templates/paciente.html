{% extends "base.html" %}
{% block title %}Painel do Paciente — Clínica Vida+{% endblock %}
{% block nav_actions %}<a href="{{ url_for('user.user') }}" class="btn btn-light btn-sm">Sair</a>{% endblock %}

{% block content %}
<div class="container-lg py-3 py-md-4">
  <div class="text-center mb-3 position-relative">
    <span class="badge rounded-pill bg-primary-subtle text-primary fw-semibold px-3 py-2">Paciente</span>
    <h2 class="page-title mt-3 mb-1">Minhas consultas</h2>
    <p class="muted mb-0">Visualize seus agendamentos e solicite ajustes quando necessário.</p>
    <button class="btn btn-link position-absolute top-0 end-0 text-primary" data-bs-toggle="modal" data-bs-target="#ajudaPaciente" aria-label="Ajuda">
      <i class="bi bi-question-circle-fill fs-4"></i>
    </button>
  </div>

  <div class="card p-4 p-md-4 mb-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
      <h5 class="fw-semibold mb-0">Meu perfil</h5>
      <span class="badge rounded-pill bg-primary-subtle text-primary">Atualize seus dados</span>
    </div>
    <form method="post" action="{{ url_for('user.atualizar_perfil_paciente') }}" class="row g-3">
      <div class="col-md-6">
        <label class="form-label small text-uppercase text-muted">Nome completo</label>
        <input type="text" name="nome" class="form-control border-0 shadow-sm" value="{{ perfil.nome }}" required>
      </div>
      <div class="col-md-6">
        <label class="form-label small text-uppercase text-muted">E-mail</label>
        <input type="email" name="email" class="form-control border-0 shadow-sm" value="{{ perfil.email }}" required>
      </div>
      <div class="col-md-6">
        <label class="form-label small text-uppercase text-muted">Nova senha <span class="text-muted fw-normal">(opcional)</span></label>
        <input type="password" name="senha" class="form-control border-0 shadow-sm" placeholder="Informe para alterar">
      </div>
      <div class="col-md-6">
        <label class="form-label small text-uppercase text-muted">Confirmar nova senha</label>
        <input type="password" name="confirmar_senha" class="form-control border-0 shadow-sm" placeholder="Repita a nova senha">
      </div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i> Salvar alterações</button>
      </div>
    </form>
  </div>

  <div class="card p-4 p-md-4 mb-3">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
      <div>
        <h5 class="fw-semibold mb-1">Agendar consulta</h5>
        <p class="muted mb-0">Escolha médico, sala e horário disponível (intervalos de 30 minutos).</p>
      </div>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalAgendar"><i class="bi bi-calendar-plus me-1"></i> Nova consulta</button>
    </div>
    <div class="alert alert-light border border-dashed mb-0">Horários exibidos consideram todas as agendas em tempo real. Itens ocupados não aparecem.</div>
  </div>

  <div class="card p-4 p-md-4 mb-3">
    {% if agendamentos %}
      <div class="table-responsive rounded-4 border border-light-subtle">
        <table class="table align-middle mb-0">
          <thead>
            <tr class="text-uppercase text-muted small">
              <th>Data</th>
              <th>Hora</th>
              <th>Médico</th>
              <th>Procedimento</th>
              <th>Sala</th>
              <th class="text-end">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for a in agendamentos %}
            <tr>
              <td class="fw-semibold">{{ a['data'] }}</td>
              <td>{{ a['hora'] }}</td>
              <td>{{ a['medico'] }}</td>
              <td>{{ a['procedimento'] }}</td>
              <td>{{ a['sala'] }}</td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-primary"
                        data-bs-toggle="modal"
                        data-bs-target="#modalAjuste"
                        data-agendamento="{{ a['id'] }}"
                        data-data="{{ a['data'] }}"
                        data-hora="{{ a['hora'] }}"
                        data-medico="{{ a['medico_id'] }}"
                        data-sala="{{ a['sala_id'] }}">
                  <i class="bi bi-calendar2-week"></i> Solicitar ajuste
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="alert alert-primary mb-0 text-center">Você ainda não possui consultas agendadas.</div>
    {% endif %}
  </div>

  <div class="card p-4 p-md-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
      <h5 class="fw-semibold mb-0">Minhas solicitações</h5>
      <span class="badge rounded-pill bg-primary-subtle text-primary">{{ ajustes|length }} registro(s)</span>
    </div>

    {% if ajustes %}
      <ul class="list-group list-group-flush">
        {% for j in ajustes %}
          <li class="list-group-item">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
              <div>
                <div class="d-flex align-items-center gap-2 mb-1">
                  <strong>Para: {{ j['novo_dia'] }} {{ j['nova_hora'] }}</strong>
                  <span class="badge px-3 py-2" data-status-badge="{{ j['status'] }}">{{ j['status'] }}</span>
                </div>

                {% if j['motivo'] %}
                  <div class="small text-muted">Seu motivo: {{ j['motivo'] }}</div>
                {% endif %}

                {% if j['status'] == 'negado' and j['motivo_negativa'] %}
                  <div class="small text-muted">Motivo da negativa: {{ j['motivo_negativa'] }}</div>
                {% endif %}

                <div class="small text-muted">Consulta atual: {{ j['data_atual'] }} {{ j['hora_atual'] }}</div>
              </div>

              <small class="text-muted">Enviado em {{ j['criado_em'] }}</small>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <div class="alert alert-light mb-0">Nenhuma solicitação enviada.</div>
    {% endif %}
  </div>

  <!-- Modal de ajuste -->
  <div class="modal fade" id="modalAjuste" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" id="formAjuste" method="POST">
        <div class="modal-header" style="background: linear-gradient(135deg, #0d6efd, #0a58ca);">
          <h5 class="modal-title text-white">Solicitar ajuste</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-6">
              <label class="form-label small text-uppercase text-muted">Novo dia</label>
              <input type="date" name="novo_dia" class="form-control border-0 shadow-sm" required>
            </div>
            <div class="col-6">
              <label class="form-label small text-uppercase text-muted">Nova hora</label>
              <select name="nova_hora" class="form-select border-0 shadow-sm" required>
                <option value="">Selecione o dia para ver horários</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label small text-uppercase text-muted">Motivo (opcional)</label>
              <textarea name="motivo" class="form-control border-0 shadow-sm" rows="3" maxlength="240"
                        placeholder="Descreva brevemente o motivo..."></textarea>
            </div>
          </div>
          <small class="text-muted d-block mt-3">A recepção analisará sua sugestão e retornará.</small>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary w-100" id="btnEnviar">
            <i class="bi bi-send"></i> Enviar solicitação
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal agendar -->
  <div class="modal fade" id="modalAgendar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form class="modal-content" method="POST" action="{{ url_for('user.agendar_consulta_paciente') }}">
        <div class="modal-header" style="background: linear-gradient(135deg, #0d6efd, #0a58ca);">
          <h5 class="modal-title text-white">Agendar nova consulta</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label small text-uppercase text-muted">Médico</label>
              <select name="medico_id" class="form-select border-0 shadow-sm" required>
                <option value="">Selecione</option>
                {% for medico in medicos %}
                  <option value="{{ medico.id }}">{{ medico.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label small text-uppercase text-muted">Procedimento</label>
              <select name="procedimento_id" class="form-select border-0 shadow-sm" required>
                <option value="">Selecione</option>
                {% for proc in procedimentos %}
                  <option value="{{ proc.id }}">{{ proc.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label small text-uppercase text-muted">Sala</label>
              <select name="sala_id" class="form-select border-0 shadow-sm" required>
                <option value="">Selecione</option>
                {% for sala in salas %}
                  <option value="{{ sala.id }}">{{ sala.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label small text-uppercase text-muted">Convênio</label>
              <input list="listaConveniosPaciente" name="convenio" class="form-control border-0 shadow-sm" placeholder="Convênio ou particular">
              <datalist id="listaConveniosPaciente">
                {% for convenio in convenios %}
                  <option value="{{ convenio }}"></option>
                {% endfor %}
              </datalist>
            </div>
            <div class="col-md-6">
              <label class="form-label small text-uppercase text-muted">Data</label>
              <input type="date" name="data" class="form-control border-0 shadow-sm" required>
            </div>
            <div class="col-md-6">
              <label class="form-label small text-uppercase text-muted">Horário</label>
              <select name="hora" class="form-select border-0 shadow-sm" required>
                <option value="">Selecione médico, sala e data</option>
              </select>
            </div>
          </div>
          <small class="text-muted d-block mt-3">Apenas horários livres são exibidos, em blocos de 30 minutos.</small>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary w-100"><i class="bi bi-calendar-check"></i> Confirmar agendamento</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Ajuda -->
  <div class="modal fade" id="ajudaPaciente" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Dúvidas frequentes</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <ul class="list-unstyled mb-0 small">
            <li class="mb-2"><strong>Como agendar:</strong> clique em "Nova consulta", escolha médico, sala e a data. Apenas horários livres aparecerão.</li>
            <li class="mb-2"><strong>Não consigo marcar:</strong> verifique se todos os campos foram preenchidos e se há salas disponíveis para o médico.</li>
            <li class="mb-2"><strong>Horário cheio:</strong> tente outra data ou médico; os horários ocupados não são exibidos.</li>
            <li><strong>Não consigo acessar:</strong> saia da conta e faça login novamente; se persistir, contate a recepção.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block body_scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const modalEl = document.getElementById('modalAjuste');
  const form = document.getElementById('formAjuste');
  const btn = document.getElementById('btnEnviar');
  const diaInput = form.querySelector('input[name="novo_dia"]');
  const horaSelect = form.querySelector('select[name="nova_hora"]');

  modalEl.addEventListener('show.bs.modal', event => {
    const button = event.relatedTarget;
    const agId = button.getAttribute('data-agendamento');
    const data = button.getAttribute('data-data');
    const hora = button.getAttribute('data-hora');
    const medico = button.getAttribute('data-medico');
    const sala = button.getAttribute('data-sala');

    modalEl.querySelector('.modal-title').innerText = `Solicitar ajuste — ${data} ${hora}`;
    form.action = `/user/paciente/solicitar_ajuste/${agId}`;
    form.reset();
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-send"></i> Enviar solicitação';
    horaSelect.innerHTML = '<option value="">Selecione o dia para ver horários</option>';
    horaSelect.disabled = true;

    form.dataset.agendamento = agId;
    form.dataset.medico = medico;
    form.dataset.sala = sala;

    diaInput.value = data;
    carregarHorarios();
  });

  modalEl.addEventListener('hidden.bs.modal', () => {
    form.reset();
    delete form.dataset.agendamento;
    delete form.dataset.medico;
    delete form.dataset.sala;
    horaSelect.innerHTML = '<option value="">Selecione o dia para ver horários</option>';
    horaSelect.disabled = true;
    btn.disabled = false;
    btn.innerHTML = '<i class="bi bi-send"></i> Enviar solicitação';
  });

  async function carregarHorarios() {
    const dia = diaInput.value;
    const agendamentoId = form.dataset.agendamento;

    if (!dia || !agendamentoId) {
      horaSelect.innerHTML = '<option value="">Selecione o dia para ver horários</option>';
      horaSelect.disabled = true;
      return;
    }

    horaSelect.innerHTML = '<option value="">Carregando horários...</option>';
    horaSelect.disabled = true;

    try {
      const res = await fetch(`/user/paciente/horarios_disponiveis?agendamento_id=${agendamentoId}&dia=${dia}`);
      const data = await res.json();

      if (!res.ok) {
        const msg = data?.msg || 'Erro ao carregar horários.';
        horaSelect.innerHTML = `<option value="">${msg}</option>`;
        return;
      }

      if (!Array.isArray(data) || data.length === 0) {
        horaSelect.innerHTML = '<option value="">Nenhum horário livre neste dia</option>';
      } else {
        horaSelect.innerHTML = data.map(h => `<option value="${h}">${h}</option>`).join('');
      }
      horaSelect.disabled = false;
    } catch (err) {
      horaSelect.innerHTML = '<option value="">Erro ao carregar horários</option>';
      window.spawnToast?.('Erro ao carregar horários disponíveis.', 'danger');
    }
  }

  diaInput.addEventListener('change', carregarHorarios);

  // agendar modal
  const agendarModal = document.getElementById('modalAgendar');
  if (agendarModal) {
    const formAgendar = agendarModal.querySelector('form');
    const selects = formAgendar.querySelectorAll('select[name="medico_id"], select[name="sala_id"], input[name="data"]');
    const horaSelect = formAgendar.querySelector('select[name="hora"]');

    const atualizarHorariosNovo = async () => {
      const medico = formAgendar.querySelector('select[name="medico_id"]').value;
      const sala = formAgendar.querySelector('select[name="sala_id"]').value;
      const dia = formAgendar.querySelector('input[name="data"]').value;
      if (!(medico && sala && dia)) {
        horaSelect.innerHTML = '<option value="">Selecione médico, sala e data</option>';
        horaSelect.disabled = true;
        return;
      }
      horaSelect.innerHTML = '<option value="">Carregando horários livres...</option>';
      horaSelect.disabled = true;
      try {
        const res = await fetch(`/user/paciente/horarios_novo?medico_id=${medico}&sala_id=${sala}&dia=${dia}`);
        const data = await res.json();
        if (Array.isArray(data) && data.length > 0) {
          horaSelect.innerHTML = data.map(h => `<option value="${h}">${h}</option>`).join('');
          horaSelect.disabled = false;
        } else {
          horaSelect.innerHTML = '<option value="">Nenhum horário disponível</option>';
        }
      } catch (err) {
        horaSelect.innerHTML = '<option value="">Erro ao buscar horários</option>';
      }
    };

    selects.forEach(el => el.addEventListener('change', atualizarHorariosNovo));
    agendarModal.addEventListener('shown.bs.modal', () => {
      atualizarHorariosNovo();
    });
  }

  const statusBadges = document.querySelectorAll('[data-status-badge]');
  statusBadges.forEach(badge => {
    badge.textContent = badge.textContent.charAt(0).toUpperCase() + badge.textContent.slice(1);
  });
});
</script>
{% endblock %}
